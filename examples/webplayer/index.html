<!doctype html>
<html lang="en-US">
    <head>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
        <title>opl-emu web-player</title>
    </head>

    <body>
        <script type="module">
            import init, { init_player } from "./pkg/webplayer.js";

            await init();
            var player; // needs to be initialised through a user interaction, will be done in the imf file upload

            async function handleImfUpload() {
                const file = document.getElementById("uploadImf").files[0];
                const reader = new FileReader();
                reader.onload = async (event) => {
                    if (!player) {
                        // init_player has to be called in onload (or some other user request to play audio)
                        player = await init_player();
                    }
                    const track_data = new Uint8Array(event.target.result);
                    player.play_imf(track_data);
                    document.getElementById("imfStatus").innerText = "ðŸŽ¶ Playing track " + file.name + "ðŸŽ¶";
                };
                reader.readAsArrayBuffer(file);
            }
            document.getElementById("uploadImf").addEventListener("change", handleImfUpload);

            async function handleAdlUpload() {
                const file = document.getElementById("uploadAdl").files[0];
                const reader = new FileReader();
                reader.onload = async (event) => {
                    if (!player) {
                        alert("You must first upload a track (imf file)");
                        return;
                    }

                    const sound_data = new Uint8Array(event.target.result);
                    player.play_adl(sound_data);
                    document.getElementById("adlStatus").innerText = "ðŸŽ¶ Playing sound file " + file.name + "ðŸŽ¶";
                };
                reader.readAsArrayBuffer(file);
            }
            document.getElementById("uploadAdl").addEventListener("change", handleAdlUpload);

            async function handleDigiUpload() {
                const file = document.getElementById("uploadDigi").files[0];
                const reader = new FileReader();
                reader.onload = async (event) => {
                    if (!player) {
                        player = await init_player();
                    }

                    const digi_data = new Uint8Array(event.target.result);
                    player.play_digi(digi_data);
                    document.getElementById("digiStatus").innerText = "ðŸŽ¶ Playing digi sound file " + file.name + "ðŸŽ¶";
                };
                reader.readAsArrayBuffer(file);
            }
            document.getElementById("uploadDigi").addEventListener("change", handleDigiUpload);
        </script>

        <label for="uploadImf">Choose a track file to play (.imf file):<br /> </label>
        <input id="uploadImf" type="file" />
        <div style="padding-top: 10px" id="imfStatus"></div>
        <br />
        <br />
        <label for="uploadAdl">Choose a sound file to play (.adl file):<br /> </label>
        <input id="uploadAdl" type="file" />
        <div style="padding-top: 10px" id="adlStatus"></div>
        <br />
        <br />
        <label for="uploadDigi">Choose a sound file to play (.digi file):<br /> </label>
        <input id="uploadDigi" type="file" />
        <div style="padding-top: 10px" id="digiStatus"></div>
    </body>
</html>
